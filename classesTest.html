
<!--Capstone Group 7: Hackstreet Boys -->
<!--Code Visualizer -->
<!--John Bryant, Eric Collins, Kevin McKelvey, Dominic Scott -->
<!-- Begin HTML -->

<!-- Notes:

	*** 27JAN2017 ***
	Embed Javascript in seperate files

	Find package in Atom (Javascript interpreter)

	*** DONE: Clear button used to clear drawing

	*** IGNORE: String dimensions: getBBox - use to get Javascript bounding box of an SVG text element

	Have previous function calls stored on the page so that
	we can recreate the drawing quickly and edit functions


	***08 FEB2017 ***
	Use monospaced fixed-width font

	*** DONE: Get bbox for text and then use that to create larger bounding box for function

	*** DONE: Make all parameter and local boxes scalable

	*** DONE: Fix offset value


	*** 09FEB2017 ***
	Nested objects

	*** DONE: Fix padding between name and value within parameters. Make it tight so they look
		like they are associated with one another

	*** DONE: Encapsulate parameters list within parentheses (after function name) so it is clear
		that they are parameters

	FIX: Heap elements overlap

	*** DONE: Draw pointer arrow from center of box to middle of lefthand boundary

	*** DONE: Fix function stack so that multiple drawings are on top of one another (stack grows up)***

	Function return animation

	Presence of newline indicates new function. So this way we can make multiple function calls
		in one go, rather than calling functions once at a time. Function calls go from first to last,
		top to bottom

	Have ability to define structs within the function stack as well as the heap. If "point" is specified,
		place within the stack. If "newpoint or new" is specified, put it in the heap.

-->

<!-- HTML Begin -->
<html lang="en">
<head>
    <title>Rough Draft - Master</title>
    <link rel="stylesheet" type="text/css" href="style.css">

		<!-- Begin Javascript -->
    <script>

		/** Global Variables **/
		var functions = []; // Array stores all user-defined functions
		var svgOutput = ""; // Stores entire svg string used for display and output
		var xAnchor = 10;		// Base x-position used as an "anchor" for the display
		var yAnchor = 10;		// Base y-position used as an "anchor" for the display
		var xPos = 0;				// x-position used as an "anchor" for the newest function
		var yPos = 0;				// y-position used as an "anchor" for the newest function
		var offest = 5;			// Offset value used for padding within/between containers

		/** Base class used to store all objects (functions and variables)
			* Contains fields for the name, anchor points, width, height, and offsets
			* of each member. Anchor and offsets are currently not used, currently replaced
			* by standardized global anchor/offset values
			**/
		class Members{
			constructor(name){
				this.name = name;             // name of member
				//this.width = this.width();  // width of box
				this.height = this.height();  // height of box
				this.charWidth = 12.05;       // standard character width
				this.charHeight = 30;         // standard character height
				this.offset = 5;              // offset used as "padding" between elements
			}

      // Class specific functions
			width()  { return 1; }
			height() { return 1; }
			draw(){}
		}

		/** Function class is used to define a "function" which is provided parameters
			* and local variables by the user.
			**/
		class Function extends Members{
			constructor(name,para,local){
				super(name);
				this.para = para; 				// array of parameters (which are members)
				this.local = local; 			// array of local variables (which are members)
				//this.populateElements(); 	// used to define width and height
			}

			nameLength(){ return this.name.length*this.charWidth + 15; } // length of function name in pixels

			// Iterate over parameters and local variables to create total height and width
			// for the bounding box.
			populateElements(){
				//for(var i = 0; i < this.para.length; i++){ this.width += this.para[i].width; }
				//for(var i = 0; i < this.local.length; i++){ this.height += this.local[i].height; }
			}

			// Calculate height of box by computing the sum of all characters in the locals array
			heightOfBox(){
				var height = this.offset; // initialize height to 5 pixels
				for( var i = 0; i < this.local.length + 1; i++){ height += this.charHeight; }
				return height;
			}

			widthOfBox(){
				var width = this.offset*4; 							// initialize width to 10 pixels
				width += this.nameLength(); // add length of function name to width total
				for(var i = 0; i < this.para.length; i++){ width += this.para[i].widthTot(); }
				return width;
			}

			// Draw function generates SVG text with the parameters defined in each function.
			draw(x,y){
				var retString = ""; // initialize empty string
				retString += "<rect x=\"" + x + "\" y=\"" + y + "\" width=\"" + this.widthOfBox() + "\" height=\"" + this.heightOfBox() + "\" style=\"stroke: black; fill:none;\"/>";
				x += 10; // offset for function name
				y += 20; // offset for function name
				retString += "<text x=\"" + x + "\" y=\"" + y + "\" style=\"stroke: black; fill: none;stroke-width: 1;font-size: 20\" >" + this.name + "</text>";

				x += this.nameLength() - 15;
				retString += "<text x=\"" + x + "\" y=\"" + y + "\" style=\"stroke: black; fill: none;stroke-width: 1;font-size: 20\" > ( </text>";
				x += this.widthOfBox() - this.nameLength() - this.offset*2;
				retString += "<text x=\"" + x + "\" y=\"" + y + "\" style=\"stroke: black; fill: none;stroke-width: 1;font-size: 20\" > ) </text>";
				return retString;
			}
		}

		/** Object class is used to create a pointer to an object that
			* appears as its own isolated box.
			*/
		class Object extends Members{
			constructor(name,objName,vals){
				super(name);
				this.variables = vals;
				this.objName = objName;
				this.width = 100;
				this.height = 50;
			}

			heightOfBox(){
				var height = this.offset;
				for( var i = 0; i < this.variables.length + 1; i++){ height += this.charHeight; }
				return height;
			}

			widthOfBox(){
				var width = this.offset*3;

				var nameWidth = this.objName.length*this.charWidth;

				var varWidth = 0;
				for (var i = 0; i < this.variables.length; i++) {
					if (this.variables[i].width > varWidth) {
						varWidth = this.variables[i].width;
					}
				}

				if (nameWidth >= varWidth) { width = nameWidth + this.offset*3; }
				else { width = varWidth + this.offset*4; }
				return width;
			}

			// Receives current xPos and yPos from drawFunction()
			draw(x,y){
				var retString = "";
				var xKey = x + 10		// x-position for text
				var yKey = y				// y-position for text
				var xBox = x + 27.5	// x-position for box
				var yBox = y - 17.5	// y-position for box
				var x1 = 0					// x-position for base of pointer
				var y1 = 0					// y-position for base of pointer
				var x2 = 0					// x-position for tip of pointer
				var y2 = 0					// y-position for tip of pointer

				// Draw name and bounding box within heap
				retString += "<rect x=\"" + xBox + "\" y=\"" + yBox + "\" width=\"22.5\" height=\"22.5\" style=\"stroke: black; fill:none;\"/>";
				retString += "<text x=\"" + xKey + "\" y=\"" + yKey + "\" style=\"stroke: black; fill: none;stroke-width: 1;font-size: 20\" >" + this.name + "</text>";
				x1 = xBox + 11.25
				y1 = yBox + 11.25

				// Draw name and bounding box on the stack
				x += 200;
				y = y;
				retString += "<rect x=\"" + x + "\" y=\"" + y + "\" width=\"" + this.widthOfBox() +"\" height=\"" + this.heightOfBox() +"\" style=\"stroke: black; fill:none;\"/>";
				x2 = x
				y2 = y + this.heightOfBox()/2
				x += 10;
				y += 20;
				retString += "<text x=\"" + x + "\" y=\"" + y + "\" style=\"stroke: black; fill: none;stroke-width: 1;font-size: 20\" >" + this.objName + "</text>";

				// Draw line pointer from middle of stack box to left-center of heap box
				retString += "<line x1=\"" + x1 + "\" y1=\"" + y1 + "\" x2=\"" + x2 + "\" y2=\"" + y2 + "\" style=\"stroke:rgb(0,0,0);stroke-width:2\" />"

				y += 10;
				for (var i = 0; i < this.variables.length; i++){
					y += this.variables[i].height;
					retString += this.variables[i].draw(x,y);
					y += 10;
				}

				return retString;
			}
		}

		/** Variable class stores a name and a value for individual variables */
		class Var extends Members{
			constructor(name,v){
				super(name);
				this.value = v;
				this.width = this.widthTot();
				this.height = 20;

			}

			/** Width function calculates the width (in pixels) of the name and value strings
			 	*These values are added together with the x-offset value to generate the width
			  *of the container
				*/
			widthTot(){
				var width = 0;
				width += 25;
				width += this.name.length*this.charWidth;
				width += this.value.length*this.charWidth;
				return width;
			}
			widthValue(){
				var width = 10;
				width += this.value.length*this.charWidth;
				return width;
			}
			widthName(){
				return this.name.length*this.charWidth + 10;
			}

			draw(x,y){
				//window.alert(x + " " + y);
				x += 10
				var xBox = x + this.widthName() - this.offset;
				var yBox = y - 17.5
				var xValue = x + this.widthName();
				var yValue = y
				var retString = "";
				retString += "<rect x=\"" + xBox + "\" y=\"" + yBox + "\" width=\"" + this.widthValue() +"\" height=\"" + this.height +"\" style=\"stroke: black; fill:none;\"/>";
				retString += "<text x=\"" + x + "\" y=\"" + y + "\" style=\"stroke: black; fill: none;stroke-width: 1;font-size: 20\" >" + this.name + "</text>";
				retString += "<text x=\"" + xValue + "\" y=\"" + yValue + "\" style=\"stroke: black; fill: none;stroke-width: 1;font-size: 20\" >" + this.value + "</text>";
				return retString;
			}
		}

		// Function called to remove the last 'function' placed on the call stack
		function returnFun(){
			functions = [];
			svgOutput += "<svg x=\"0\" y=\"0\" width=\"400\" height=\"400\">"
			svgOutput += drawFunction();
			svgOutput += "</svg>";

			console.log(svgOutput);
			document.getElementById("out").innerHTML = svgOutput;
		}

		// takes variable from (example) 'x=3' to an Var object
		function parseVariable(variable){
			var sVar = variable.split("=");
			return new Var(sVar[0],sVar[1]);
		}

		// builds an array for the new object in order to store in the Object class
		function buildObjectArray(variables){
			var vars = [];
			for(var i = 0; i < variables.length; i++){
				var sVar = variables[i].split("=");
				vars.push(new Var(sVar[0],sVar[1]));
			}
			return vars;
		}

		// takes a new object from 'Point(x=2,y=1)' to and Object that has the values name and variables populated
		function newObject(fullObj){
			parseOne = fullObj.replace('(',' ');
			parseOne = parseOne.replace(')','');
			parsedObj = parseOne.split(' ');
			names = parsedObj[0].split('=')
			varsArray = buildObjectArray(parsedObj[1].split(','));
			return new Object(names[0],names[1],varsArray);
		}

		// creates an array of variable objects, whether Var or Object, to be used to create the new function
		function storeVariables(variables){
			var vars = [];
			for(var i = 0; i < variables.length; i++){
				if (/[A-Za-z0-9]*\([A-Za-z0-9=,]*\)/.test(variables[i])){
					vars.push(newObject(variables[i]));
				}
				else {
					vars.push(parseVariable(variables[i]));
				}
			}
			return vars;
		}

		function call(){
			var svgOutput = "" // clear svgOutput before each addition to the stack
			var rawText = document.getElementById("functioncall").value;
			var mainArray = rawText.split("."); // need error checking
			var paraText = mainArray[1].split(";"); // need error checking
			var localText = mainArray[2].split(";"); // need error checking
			var para = storeVariables(paraText);
			var local = storeVariables(localText);
			functions.push(new Function(mainArray[0],para,local)); // used to store all user-defined functions
			//window.alert(functions);

			// generate svg below. "content" is the string used to store the entire svg text
			svgOutput += "<svg x=\"0\" y=\"0\" width=\"400\" height=\"400\">"
			svgOutput += drawFunction();
			svgOutput += "</svg>";

			console.log(svgOutput);
			document.getElementById("out").innerHTML = svgOutput;
		}

		// Generates svg text based off of the parsed code passed as an argument
    function drawFunction(){
			//window.alert(xPos + " " + yPos);
			var retString = "";
			// loop over all members in "functions" and generate one long svg string for them
			xPos = xAnchor // reinitialize the xPosition to the anchor
			yPos = yAnchor
			for(var i = functions.length - 1; i >= 0; i--){
				retString += functions[i].draw(xPos,yPos);

				var xTemp = xPos
				var yTemp = yPos
				xTemp += functions[i].nameLength();
				yTemp += 20;

				//Loop over parameters
				for(var j=0; j < functions[i].para.length; j++){
					retString += functions[i].para[j].draw(xTemp,yTemp);
					xTemp += functions[i].para[j].widthTot();
				}

				// Loop over locals
				xTemp = xPos
				yTemp = yPos + functions[i].charHeight + 25;
				for(var j=0; j < functions[i].local.length; j++){
					retString += functions[i].local[j].draw(xTemp,yTemp);
					yTemp += functions[i].local[j].charHeight;
				}

				yPos += functions[i].heightOfBox() + 15;
			}

      return retString;
    }

		/** Saves svg output in plaintext to a file specified by the user
			* Does not save if no output exists or if the filename is not specified
			*/
    function saveTextAsFile(){
      var textToSave = svgOutput
			var fileNameToSaveAs = document.getElementById("saveFileName").value;

			if ( textToSave != "" && fileNameToSaveAs != ""){
				// https://thiscouldbebetter.wordpress.com/2012/12/18/loading-editing-and-saving-a-text-file-in-html5-using-javascrip/
				var textToSaveAsBlob = new Blob([textToSave], {type:"text/plain"});
				var textToSaveAsURL = window.URL.createObjectURL(textToSaveAsBlob);

				var downloadLink = document.createElement("a");
				downloadLink.download = fileNameToSaveAs;
				downloadLink.innerHTML = "Download File";
				downloadLink.href = textToSaveAsURL;
				downloadLink.onclick = destroyClickedElement;
				downloadLink.style.display = "none";
				document.body.appendChild(downloadLink);

				downloadLink.click();
			}
			else {
				if ( textToSave == "" ){
					window.alert("No output to save");
				}
				if (fileNameToSaveAs == "") {
					window.alert("Please specify a filename")
				}
			}
    }

		// https://thiscouldbebetter.wordpress.com/2012/12/18/loading-editing-and-saving-a-text-file-in-html5-using-javascrip/
    function destroyClickedElement(event){
        document.body.removeChild(event.target);
    }

		function clearStack(){
			functions = [];
			svgOutput = "";
			document.getElementById("out").innerHTML = svgOutput;
			window.location.reload();
		}
    </script>
		<!-- End Javascript -->

</head>
<!-- End HTML head -->

<!-- Begin HTML body -->
<body>
    <div>
        <!--Header-->
        <div class="header">Master</div>

        <!--Input-->
        <div class="input">
					<p>Type code in the text field.</p>
          <p>Ex:</p>
          <p>main.x=3;y=2.a=1;b=2</p>
					<p>Example with an Object:</p>
					<p>main.x=3;y=2.a=1;b=point(x=1,y=1)</p>

					Function Call: <textarea id="functioncall" rows="5" cols="35"></textarea>

					<br>

					<button onclick="call()"> Function Call </button>

		    	<br><br>

					<button onclick="returnFun()"> Return </button>

					<br><br>

					<button onclick="clearStack()"> Clear Stack </button>

					<br><br>

		      FileName: <textarea id="saveFileName" rows="1" cols="15"></textarea>
					<button onclick="saveTextAsFile()"> Save to File </button>

      </div>

			<!-- SVG Output goes here -->
      <div  class="output">
      	<div id ="out"> </div>
      </div>

      <!--FOOTER-->
      <div class="footer">
        <b>Hackstreet Boys</b> - Capstone<br/>
      </div>

    </div>

    <div id="test"> </div>

</body>
</html>
